<script src="js/jquery.min.js"></script>
<script src="js/math.js"></script>
<script>
// Listen to message from main app
// ===============================================================================================
window.addEventListener('message', function(event) {
	var data_return = {};
	var protocol_id_macro_id = [];

	// Generate macro functions
	// ===============================================================================================
	for(i in event.data.sandbox.macros){
		var macro_id = event.data.sandbox.macros[i].id;
		var macro_name = "macro_"+macro_id;
		var macro_javascriptcode = event.data.sandbox.macros[i].javascript_code;
		window[macro_name] = Function('json', macro_javascriptcode);
	}

	// Get macro lookup table
	// ===============================================================================================
	protocol_lookup = event.data.sandbox.protocols;
	
	// Run macros on data
	// ===============================================================================================
	for(sampleID in event.data.sandbox.devicedata.sample){
		for(measurementID in event.data.sandbox.devicedata.sample[sampleID]){

			// Get Protocol_ID from measurement
			var protocol_id = event.data.sandbox.devicedata.sample[sampleID][measurementID].protocol_id;
			
			// Get macro name from protocol_id
			var macro_name = 'macro_'+protocol_lookup[protocol_id].macro_id;

			// JSON passed on to the macro
			var protocol_data = event.data.sandbox.devicedata.sample[sampleID][measurementID];

			// Assigning macro function to protocol
			var fn = window[macro_name];

			// Run function if exists
			if (typeof fn === "function"){
				if(data_return[sampleID] === undefined)
					data_return[sampleID] = {}
				try {
					data_return[sampleID][measurementID] = fn.apply(null, new Array(protocol_data));
				}
				catch(e){
					console.log(e);
				}
			}
		}
	}

	// Return macro output to main app
	// ===============================================================================================
	event.source.postMessage({'graph':data_return}, event.origin);

});
</script>